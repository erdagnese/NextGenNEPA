---
title: "tax_asvs_to_phyloseq"
author: "Erin D'Agnese"
date: "8/2/2021"
output: 
  html_notebook:
    toc: true
params:
  folder:
    value: C:\Users\erdag\github\NextGenNEPA\Output\phyloseq_output\run2_rerun\MiX 
  hashes.annotated:
    value: C:\Users\erdag\github\NextGenNEPA\Output\hashes_to_taxonomy_output\run2_rerun_crux\MiX\2021-10-11hashes.annotated.rds
  ASV: 
   value: C:\Users\erdag\github\NextGenNEPA\Output\dada2_output_files\run2_rerun_20211011\MiX_ASV_table.csv
  metadata:
      value: C:\Users\erdag\github\NextGenNEPA\Input\sequencing_metadata_files\master_sequencing_datasheet20211011.csv
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = params$folder)
```

Need to take the hashes annotated .rds in the github outputs, use the ASV table with hashes and make it
into a phyloseq object


```{r libraries and functions}
library(tidyverse)
library(here)
library(phyloseq)
```
load source function scripts
```{r}
source(here("functions","asv.matrix.R"))
source(here("functions","making.phyloseq.obj.R"))
source(here("functions", "tax.table.R"))
```


load the taxonomy file from the project file
```{r}
tax.input <- read_rds(params$hashes.annotated)
asv.mat <- read_csv(params$ASV)
metadata <- read_csv(params$metadata)
```
ONLY USE THIS FOR THE 12S ASV TABLE IF THEY AREN'T SPLIT
```{r}
asv_fish <- asv.mat[asv.mat$Locus =="MiFish",]
asv_mam <- asv.mat[asv.mat$Locus =="MiMammal",]
#lets assign mifish to asv.mat for the future work first
asv.mat <- asv_fish
```

Select out the metadata for the correct run locus of choice
```{r}
metadata <- metadata[metadata$Sequencing.run == "2",]
metadata <- metadata[metadata$Locus == "MiFish",]
```


Making the ASV table into a matrix 
```{r ASV pivot}
asv.mat <- asv.matrix(asv.mat)
```

making annotated hashes into the taxtable
```{r}
#first reorder so that taxon is after species
tax.input <- tax.input %>% relocate(taxon, .after = species)
tax.mat <- tax.table(tax.input)
```
making a phyloseq object from the input
```{r}
phylo <- make.phyloseq.obj(asv.mat, metadata, tax.mat)
```

check that things are working with a barplot
```{r}
plot_bar(phylo, fill = "family")
```

filter out the bacteria and uncharacterized/no rank ASVs
```{r}
phylo <- subset_taxa(phylo, !is.na(kingdom) & !kingdom %in% c("","no rank", "uncharacterized"))
```

check again to make sure they were removed
```{r}
plot_bar(phylo, fill = "kingdom")
```


then collapse to taxon and produce an OTU table to be combined with other run OTU tables later
```{r}
taxon_glom <- tax_glom(phylo, taxrank = "taxon")
#check that it kept all the column data

```

